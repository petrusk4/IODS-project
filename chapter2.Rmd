# 2: Regression and model validation

> ### Instructions
> Describe the work you have done this week and summarize your learning.
>
> - Describe your work and results clearly. 
> - Assume the reader has an introductory course level understanding of > writing and reading R code as well as statistical methods.
> - Assume the reader has no previous knowledge of your data or the more advanced methods you are using.

## ***Data wrangling***

Sections 2.0 -- 2.6 produce a dataset named `data/learning2014.csv`. For statistical analysis, skip to **section 2.7**.


## 2.0 Packages

Let's first load the required packages.

```{r}
pacman::p_load(tidyverse, GGally, patchwork)
```


## 2.1 Reading data from the web

Let's begin by exploring our dataset. Click here for [metadata](http://www.helsinki.fi/~kvehkala/JYTmooc/JYTOPKYS3-meta.txt).

```{r}
# Get data
lrn14 <- read.table("http://www.helsinki.fi/~kvehkala/JYTmooc/JYTOPKYS3-data.txt", sep = "\t", header = TRUE)

# Check dimensions
dim(lrn14)
# str(lrn14)
```


### Observations from the data:

- Looks like the `lrn14` dataset has `r nrow(lrn14)` rows and `r ncol(lrn14)` columns.
- Most columns appear to be intergers, whereas only `gender` is character.


## 2.2 Scaling variables

> ### Instructions
> - Execute the example codes to see how vectorized division works
> - Use vector division to create a new column `attitude` in the `lrn14` data frame, where each observation of `Attitude` is scaled back to the original scale of the questions, by dividing it with the number of questions.
> 
> Hint:
> - Assign 'Attitude divided by 10' to the new column 'attitude.

```{r fig.width=4, fig.height=2}
# Scale the attitude variable to match other variables
lrn14 <- lrn14 %>%
  mutate(attitude = Attitude / 10)

# Check the distribution
lrn14 %>% ggplot(aes(x = attitude)) + geom_density()
```


## 2.3 Combining variables

> ### Instructions
> - Access the **dplyr** library
> - Execute the example codes to create the combination variables 'deep' and 'surf' as columns in `lrn14`
> - Select the columns related to strategic learning from `lrn14`
> - Create the combination variable 'stra' as a column in `lrn14`

> Hints:
> - Columns related to strategic learning are in the object `strategic_questions`. Use it for selecting the correct columns.
> - Use the function `rowMeans()` identically to the examples

```{r}
# Classify questions
deep <- c(
  "D03", "D11", "D19", "D27", "D07", "D14",
  "D22", "D30","D06",  "D15", "D23", "D31"
)
surf <- c(
  "SU02", "SU10", "SU18", "SU26", "SU05", "SU13",
  "SU21", "SU29", "SU08", "SU16", "SU24", "SU32"
)
stra <- c(
  "ST01", "ST09", "ST17", "ST25",
  "ST04", "ST12", "ST20", "ST28"
)

# Create averages in a loop
for (Qclass in c("deep", "surf", "stra")) {
  lrn14[[Qclass]] <- rowMeans(lrn14[, get(Qclass)])
}

# Same thing, without creating new objects in the environment
# lrn14 <- lrn14 %>%
#   rowwise() %>%
#   mutate(
#     deep = mean(c( # Deep questions
#       D03, D11, D19, D27, D07, D14, D22, D30, D06, D15, D23, D31
#     )),
#     surf = mean(c( # Surface questions
#       SU02, SU10, SU18, SU26, SU05, SU13, SU21, SU29, SU08, SU16, SU24, SU32
#     )),
#     stra = mean(c( # Strategic questions
#       ST01, ST09, ST17, ST25, ST04, ST12, ST20, ST28
#     ))
#   ) %>% ungroup()
```


## 2.4 Selecting columns

> ### Instructions
> - Access the **dplyr** library
> - Create object `keep_columns`
> - Use `select()` (possibly together with `one_of()`) to create a new data frame `learning2014` with the columns named in `keep_columns`.
> - Look at the structure of the new dataset
> 
> Hint:
> - See the previous exercise or the data wrangling cheatsheet for help on how to select columns

```{r}
# Pick relevant vars
keep_columns <- c(
  "gender",
  "Age",
  "attitude",
  "deep",
  "stra",
  "surf",
  "Points"
)

# Drop useless vars
learning2014 <- lrn14 %>% select(
  all_of(keep_columns)
)

# See structure
str(learning2014)
```


## 2.5 Modifying column names

```{r}
colnames(learning2014)
learning2014 <- learning2014 %>%
  rename("age" = Age, "points" = Points)
colnames(learning2014)
```


## 2.6 Excluding observations

```{r}
learning2014 <- learning2014 %>%
  filter(points > 0)
```


### Write to file

```{r}
# Write
readr::write_csv(learning2014, "data/learning2014.csv")
```


## ***Analysis***

```{r}
# Get data
data <- readr::read_csv("data/learning2014.csv")
head(data); str(data)

# Check numeric variables
data.frame(do.call(cbind, lapply(data, summary))) %>%
  select(-gender) %>%
  DT::datatable()

# Table gender
table(data$gender, useNA = "always")
```

```{r}
p <- data %>% pivot_longer(
  cols = colnames(data)[-1],
  values_to = "value",
  names_to = "var"
) %>% ggplot(aes(x = value, color = var))#, linetype = gender
p <- p + geom_density()
p <- p + scale_x_sqrt(limits = c(0, NA))
p
```


This dataset has also a variable called `gender`

```{r}
p <- data %>% ggplot(aes(x = gender, fill = gender))
p <- p + geom_bar(width = .5)
p <- p + scale_fill_manual(values = rev(c("dodgerblue", "orangered")))
p1 <- p

p <- data %>% pivot_longer(
  cols = colnames(data)[-1],
  values_to = "value",
  names_to = "var"
) %>% ggplot(aes(x = value, color = gender))#, linetype = gender
p <- p + geom_density()
# p <- p + scale_x_sqrt()
p <- p + facet_wrap(. ~ var, scales = "free")
p <- p + scale_color_manual(values = rev(c("dodgerblue", "orangered")))
p2 <- p


library(patchwork)
p1 + p2 + plot_layout(widths = c(.3, 1), guides = 'collect')

```

There is plausibilitiy that the attitude of the students or different learning strategies influence exam points. Therefore, let's glance over the potential relationships within the data:

```{r}
p <- data %>% pivot_longer(
  cols = c(attitude, deep, stra, surf),
  values_to = "answer",
  names_to = "var"
) %>% ggplot(aes(x = answer, y = points, color = var))
p <- p + geom_point(alpha = .5, size = 1)
p <- p + geom_smooth(method = "lm", se = F)
p <- p + coord_cartesian(xlim = c(0, 5))
p
```


## 2.7 Visualizations with ggplot2

```{r}
p <- data %>%
  ggplot(aes(x = attitude, y = points, col = gender))
p <- p + geom_point()
p <- p + geom_smooth(method = "lm")
p <- p + ggtitle("Student's attitude versus exam points")
p
```


## 2.8 Exploring a data frame

## 2.9 Simple regression

## 2.10 Multiple regression

## 2.11 Graphical model validation

## 2.12 Making predictions
